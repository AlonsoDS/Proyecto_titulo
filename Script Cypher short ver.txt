:param embeddingDimension => 16;
:param batchSize => 100;
:param classes => [
  'arts_and_entertainment',
  'education_prim',
  'education_sup',
  'food_and_drink',
  'food_and_drink_stores',
  'medical',
  'park_like',
  'religion',
  'security',
  'sport_and_leisure',
  'veterinary'
];

CALL apoc.periodic.iterate(
  "MATCH (a:Departamento) RETURN a",
  "WITH a, $classes AS classes
   UNWIND classes AS poiClass
   MATCH (a)-[r:CERCA_DE_CAT1|CERCA_DE_CAT2|CERCA_DE_CAT3]->(p:POI {class: poiClass})
   WITH a, poiClass, collect(p) AS pois, collect(r) AS rels
   WHERE size(pois) > 0
   WITH a, poiClass, pois, rels,
        [id(a)] + [p IN pois | id(p)] AS nodeIds
   CALL gds.graph.project.cypher(
     'tmp_' + id(a) + '_' + replace(poiClass,' ','_'),
     'MATCH (n) WHERE id(n) IN $nodeIds RETURN id(n) AS id, labels(n) AS labels',
     'MATCH (n)-[r]->(m) WHERE id(n) IN $nodeIds AND id(m) IN $nodeIds
      WITH id(n) AS source, id(m) AS target, r, m.cat AS cat
      WITH source, target,
           CASE cat
             WHEN 1 THEN 600.0
             WHEN 2 THEN 1200.0
             WHEN 3 THEN 2400.0
           END AS radio,
           r.distancia_metros AS dist
      RETURN source, target, 1.0 / (1.0 + (coalesce(dist,1.0) / radio)) AS weight',
     {parameters: {nodeIds: nodeIds}}
   ) YIELD graphName
   CALL gds.fastRP.stream({
     graph: graphName,
     embeddingDimension: $embeddingDimension,
     relationshipWeightProperty: 'weight'
   }) YIELD nodeId, embedding
   WITH a, poiClass, nodeId, embedding
   WHERE gds.util.asNode(nodeId) = a
   CALL apoc.create.setProperty(a, 'emb_' + replace(poiClass,' ','_'), embedding) YIELD node
   CALL gds.graph.drop(graphName) YIELD graphName AS dropped
   RETURN count(*) AS done",
  {batchSize: $batchSize, parallel: false, params: {classes: $classes, embeddingDimension: $embeddingDimension}}
);
